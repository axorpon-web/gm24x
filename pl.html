<!DOCTYPE html>
<html>
<head>
  <title>Game24x Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.6/shaka-player.ui.min.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.6/controls.min.css" crossorigin="anonymous">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
</head>

<body bgcolor="black" style="margin:0">
<div id="videoContainer" class="container video-fill" data-shaka-player-container
     style="position:absolute;z-index:-1;top:0;left:0;width:100%;height:100%;">
  <video autoplay data-shaka-player id="video" style="width:100%;height:100%;"></video>
</div>

<script>
  function decryptData(data) {
    const key = CryptoJS.enc.Utf8.parse("2ec7352cfcd6d116c4b0800fa95a2eea");
    const iv  = CryptoJS.enc.Utf8.parse("2f0af185c7575a7f");
    const decrypted = CryptoJS.AES.decrypt(
      { ciphertext: CryptoJS.enc.Base64.parse(data) },
      key,
      { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 }
    );
    return decrypted.toString(CryptoJS.enc.Utf8);
  }

  async function loadChannel(id) {
    const res = await fetch("/streams.json");
    const streams = await res.json();
    const stream = streams.find(s => s.id === id);
    if (!stream) throw new Error("Channel not found: " + id);

    const decrypted = decryptData(stream.data);
    return JSON.parse(decrypted);
  }

  function resizePlayer() {
    const container = document.getElementById('videoContainer');
    container.style.width = window.innerWidth + 'px';
    container.style.height = window.innerHeight + 'px';
  }

  async function init() {
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id") || "tnt1";

    const { url, license_key, license_key2 } = await loadChannel(id);

    const video = document.getElementById('video');
    const ui = video['ui'];
    const controls = ui.getControls();
    const player = controls.getPlayer();

    player.configure({
      drm: {
        clearKeys: {
          [license_key]: license_key2
        }
      },
      streaming: {
        bufferingGoal: 60,
        rebufferingGoal: 2,
        lowLatencyMode: true,
        retryParameters: { maxAttempts: 5, timeout: 10000 }
      }
    });

    try {
      await player.load(url);
      video.muted = false;
      await video.play();
    } catch (err) {
      console.error("Error loading stream:", err);
    }
  }

  document.addEventListener('shaka-ui-loaded', init);
  window.addEventListener('resize', resizePlayer);
  resizePlayer();
</script>
</body>
</html>
